# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä

## –ü—Ä–æ–±–ª–µ–º–∞
–í–µ—Å—å —Å–∞–π—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `bitrix-docker/www`, –Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Docker –Ω–µ –Ω—É–∂–µ–Ω. –ü—Ä–∏ –æ–±—ã—á–Ω–æ–º `git pull` –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–ø–∞–¥–µ—Ç –≤–µ—Å—å –º—É—Å–æ—Ä –∏–∑ `bitrix-docker` (confs, sources, docker-compose.yml –∏ —Ç.–¥.).

## –†–µ—à–µ–Ω–∏–µ

### üöÄ –í–∞—Ä–∏–∞–Ω—Ç 0: CI/CD –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø!)

–°–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ CI/CD. –ü—Ä–∏ –∫–∞–∂–¥–æ–º `git push` –≤ –≤–µ—Ç–∫—É `main` —Å–∞–π—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ!

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (—Å–µ–π—á–∞—Å)

1. **–°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
ssh-keygen -t ed25519 -C "github-actions-test-deploy" -f ~/.ssh/github_actions_test_deploy
cat ~/.ssh/github_actions_test_deploy.pub >> ~/.ssh/authorized_keys
```

2. **–î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings ‚Üí Secrets and variables ‚Üí Actions
   - –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `TEST_`:
     - `TEST_SSH_PRIVATE_KEY` - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (`~/.ssh/github_actions_test_deploy` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
     - `TEST_SERVER_HOST` - IP –∏–ª–∏ –¥–æ–º–µ–Ω —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `test.example.com` –∏–ª–∏ `192.168.1.100`)
     - `TEST_SERVER_USER` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è SSH (`root` –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ `deploy` –¥–ª—è –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
     - `TEST_DEPLOY_PATH` - –ø—É—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∫—É–¥–∞ –¥–µ–ø–ª–æ–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/var/www/html`)
     - `TEST_WEB_USER` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–æ–±—ã—á–Ω–æ `www-data`)
     - `TEST_WEB_GROUP` - –≥—Ä—É–ø–ø–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–æ–±—ã—á–Ω–æ `www-data`)

3. **–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º `git push` –≤ `main` –∏–ª–∏ `master` –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä.

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤)

1. **–°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –Ω–∞ –±–æ–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# –ù–∞ –±–æ–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
ssh-keygen -t ed25519 -C "github-actions-production-deploy" -f ~/.ssh/github_actions_production_deploy
cat ~/.ssh/github_actions_production_deploy.pub >> ~/.ssh/authorized_keys
```

2. **–î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `PRODUCTION_`:**
   - `PRODUCTION_SSH_PRIVATE_KEY`
   - `PRODUCTION_SERVER_HOST`
   - `PRODUCTION_SERVER_USER`
   - `PRODUCTION_DEPLOY_PATH`
   - `PRODUCTION_WEB_USER`
   - `PRODUCTION_WEB_GROUP`

3. **–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ –±–æ–µ–≤–æ–π:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ `.github/workflows/deploy-production.yml`
   - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–µ–∫—Ü–∏—é `push` –≤ `on:`
   - –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** –°–º. —Ñ–∞–π–ª `CI_CD_SETUP.md`

#### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç CI/CD:

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ `bitrix-docker/www` –Ω–∞ —Å–µ—Ä–≤–µ—Ä  
‚úÖ –ò—Å–∫–ª—é—á–∞–µ—Ç –∫–µ—à, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –º—É—Å–æ—Ä  
‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞  
‚úÖ –û—á–∏—â–∞–µ—Ç –∫–µ—à Bitrix –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è  
‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ GitHub/GitLab  
‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ "Run workflow" / "Run pipeline"

---

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è

#### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/opt/eklektika-ru`):
```bash
git clone <–≤–∞—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π> /opt/eklektika-ru
cd /opt/eklektika-ru
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è:
```bash
chmod +x deploy.sh
./deploy.sh /var/www/html
```

–ì–¥–µ `/var/www/html` - —ç—Ç–æ –≤–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é).

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ git hook:

–°–æ–∑–¥–∞–π—Ç–µ post-receive hook –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
mkdir -p .git/hooks
cat > .git/hooks/post-receive << 'EOF'
#!/bin/bash
cd /opt/eklektika-ru
git pull origin main
./deploy.sh /var/www/html
EOF
chmod +x .git/hooks/post-receive
```

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ `git push` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–µ–ø–ª–æ–π.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ git sparse-checkout

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å git —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –∑–∞–≥—Ä—É–∂–∞–ª —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:

```bash
git clone --no-checkout <–≤–∞—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π> /opt/eklektika-ru
cd /opt/eklektika-ru
git sparse-checkout init --cone
git sparse-checkout set bitrix-docker/www
git checkout main
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ `git pull` –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `bitrix-docker/www`.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞

–ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞ —É–∫–∞–∑—ã–≤–∞–ª –Ω–∞ `bitrix-docker/www`:

```bash
# –ü–æ—Å–ª–µ git pull
cd /opt/eklektika-ru
ln -sfn bitrix-docker/www /var/www/html
```

–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä —Ç–∞–∫, —á—Ç–æ–±—ã DocumentRoot —É–∫–∞–∑—ã–≤–∞–ª –Ω–∞ `/opt/eklektika-ru/bitrix-docker/www`.

## –ß—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞–µ—Ç:
- `.git` - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π git
- `bitrixcache`, `bitrixmanagedcache`, `bitrixstackcache` - –∫–µ—à Bitrix
- `upload` - –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ—Ç–¥–µ–ª—å–Ω–æ)
- `temp` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `.DS_Store` - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã macOS

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–∞–π–ª `.settings.php` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

2. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞**: –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞:
```bash
chown -R www-data:www-data /var/www/html
find /var/www/html -type d -exec chmod 755 {} \;
find /var/www/html -type f -exec chmod 644 {} \;
```

3. **–§–∞–π–ª—ã upload**: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `upload` –æ–±—ã—á–Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ git. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞.

4. **–ö–µ—à Bitrix**: –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à Bitrix —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ –∫–æ–º–∞–Ω–¥–æ–π:
```bash
rm -rf /var/www/html/bitrixcache/*
rm -rf /var/www/html/bitrixmanagedcache/*
```

